<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASVAB 模拟题（整套）</title>
  <style>
    body{background:#0b1220;color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#0f172a80;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
    h1{font-size:40px;margin:28px 0}
    .small{opacity:.8;font-size:14px}
    a,select,button,input{font:inherit}
    .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:.65rem 1rem;border-radius:.8rem}
    .btn-primary{background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;border:0;padding:.7rem 1.2rem;border-radius:.8rem;box-shadow:0 6px 20px rgba(59,130,246,.25),0 2px 6px rgba(6,182,212,.35);transition:transform .08s ease,filter .2s ease;cursor:pointer}
    .btn-primary:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn-primary:active{transform:translateY(0);filter:brightness(.98)}
    .btn-primary[disabled]{opacity:.65;cursor:not-allowed;box-shadow:none}
    .btn-primary.is-loading{position:relative;color:transparent}
    .btn-primary.is-loading::after{content:"";position:absolute;inset:0;margin:auto;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.6);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
      <div style="font-weight:700">ASVAB 学习指南</div>
      <a href="index.html" class="small" style="color:#93c5fd;text-decoration:none;">← 返回首页</a>
    </div>
    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
      <div class="small" id="timer" style="color:#facc15;"></div>
      <div class="small" id="whoami"></div>
    </div>
  </header>

  <main class="wrap">
    <h1>ASVAB 模拟题（整套）</h1>

    <div class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <label>科目：
        <select id="module">
          <option value="AR">AR 算术推理</option>
          <option value="MK">MK 数学知识</option>
          <option value="WK">WK / PC 词汇与阅读</option>
          <option value="GS">GS 自然科学</option>
        </select>
      </label>

      <button id="load" class="btn-primary" onclick="onLoadClick()">加载整套</button>

      <span id="currentSet" class="small" style="margin-left:auto"></span>
      <button id="logout" class="btn">退出登录</button>
    </div>

    <div id="status" class="wrap small" style="padding-top:0;color:#93c5fd"></div>

    <div id="quiz"></div>

    <div class="card" id="actions" style="display:none;gap:12px;align-items:center">
      <button id="submit" class="btn-primary">提交答案</button>
      <button id="toggleWrong" class="btn-primary" style="display:none">只看错题</button>
      <button id="exportWrong" class="btn-primary" style="display:none">导出错题 PDF</button>
      <button id="viewHistory" class="btn">查看成绩记录</button>
    </div>

    <div class="card" id="result" style="display:none"></div>
    <div class="card" id="historyPanel" style="display:none;max-width:100%;overflow:auto"></div>
  </main>

  <!-- 全部逻辑放在一个模块脚本里，避免作用域问题 -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const { jsPDF } = await import("https://esm.sh/jspdf@2.5.1");

    const PDF_FONT_NAME = 'NotoSansSC';
    const PDF_FONT_FILE = 'NotoSansSC-Regular.ttf';
    const PDF_FONT_URL = 'https://unpkg.com/@fontsource/noto-sans-sc@5.0.0/files/noto-sans-sc-chinese-simplified-400-normal.ttf';

    let pdfFontBase64 = '';
    let pdfFontLoadingPromise = null;

    const arrayBufferToBase64 = (buffer) => {
      const bytes = new Uint8Array(buffer);
      const chunk = 0x8000;
      const chunks = [];
      for (let i = 0; i < bytes.length; i += chunk) {
        const sub = bytes.subarray(i, i + chunk);
        chunks.push(String.fromCharCode.apply(null, sub));
      }
      return btoa(chunks.join(''));
    };

    const ensurePdfFont = async (doc) => {
      const fontList = doc.getFontList?.() || {};
      if (fontList[PDF_FONT_NAME]) {
        doc.setFont(PDF_FONT_NAME, 'normal');
        return;
      }

      if (!pdfFontBase64) {
        if (!pdfFontLoadingPromise) {
          pdfFontLoadingPromise = (async () => {
            const res = await fetch(PDF_FONT_URL);
            if (!res.ok) {
              throw new Error(`字体下载失败（HTTP ${res.status}）`);
            }
            const buffer = await res.arrayBuffer();
            pdfFontBase64 = arrayBufferToBase64(buffer);
            return pdfFontBase64;
          })().catch(err => {
            pdfFontLoadingPromise = null;
            throw err;
          });
        }
        await pdfFontLoadingPromise;
      }

      if (pdfFontBase64) {
        doc.addFileToVFS(PDF_FONT_FILE, pdfFontBase64);
        doc.addFont(PDF_FONT_FILE, PDF_FONT_NAME, 'normal', 'Identity-H');
        doc.setFont(PDF_FONT_NAME, 'normal');
      }
    };


    // TODO: 替换成你自己的 URL 和 anon key
    const supabase = createClient("https://tsximmhtxysoeabxwlkv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzeGltbWh0eHlzb2VhYnh3bGt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA2MTcsImV4cCI6MjA3NjM3NjYxN30.PQ0Fldv-vl4o_LH9niy2IbJwhcrCPbsaEM7sLEgXf8U");

    // ========== 登录态检查 ==========
    const { data:sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;
    if (!session) {
      location.href = "auth.html";
      throw new Error("Not signed in");
    }
    const user = session.user;
    let studentName = "";

    // 显示姓名
    async function showName() {
      const { data:profile } = await supabase.from('profiles').select('full_name').eq('id', user.id).maybeSingle();
      studentName = profile?.full_name
        || localStorage.getItem('asvab_student_name')
        || user.user_metadata?.full_name
        || "未填写姓名";
      document.getElementById('whoami').textContent = `学员：${studentName}`;
    }
    await showName();

    // 退出登录
    document.getElementById('logout').onclick = async () => {
      await supabase.auth.signOut();
      location.href = 'auth.html';
    };

    // ========== UI / 状态 ==========
    const setStatus = (t) => document.getElementById('status').textContent = t || '';
    let activeSet=null, setsOfModule=[], questions=[], wrongList=[], onlyWrong=false;
    let examStartTs=null, examEndTs=null, lastScore=0;

    let timerInterval=null, deadlineTs=null, hasSubmitted=false;

    const DEFAULT_TIME_LIMIT_MINUTES = 60;

    const timerEl = document.getElementById('timer');

    function stopTimer(){
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval=null;
      }
    }

    function formatDuration(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const mm = String(Math.floor(total/60)).padStart(2,'0');
      const ss = String(total%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }

    function updateTimerDisplay(){
      if (!deadlineTs) { timerEl.textContent=''; return; }
      const diff = deadlineTs - Date.now();
      if (diff <= 0) {
        timerEl.textContent = '剩余时间：00:00';
        stopTimer();
        submitQuiz(true);
      } else {
        timerEl.textContent = `剩余时间：${formatDuration(diff)}`;
      }
    }

    function startTimer(limitMinutes){
      stopTimer();
      const limitMs = Math.max(1, limitMinutes) * 60 * 1000;
      deadlineTs = examStartTs + limitMs;
      updateTimerDisplay();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    // ========== 载入整套 ==========
    async function onLoadClick(){
      const btn=document.getElementById('load');
      const mod=document.getElementById('module').value;

      btn.disabled=true; btn.classList.add('is-loading'); btn.textContent='加载中…';
      setStatus('开始加载清单：/exams/manifest.json');

      try{
        const m = await fetch('exams/manifest.json?v=1',{cache:'no-store'});
        if(!m.ok) throw new Error('manifest.json 加载失败：HTTP '+m.status);
        const manifest = await m.json();

        if(!manifest[mod] || !manifest[mod].length){
          throw new Error(`manifest 中没有科目 ${mod} 的套卷条目`);
        }
        setsOfModule = manifest[mod];
        activeSet = setsOfModule[0];

        setStatus(`找到套卷：${activeSet.title}，开始加载 ${activeSet.file}`);
        const s = await fetch(`${activeSet.file}?v=1`,{cache:'no-store'});
        if(!s.ok) throw new Error(`套卷文件加载失败：HTTP ${s.status}（${activeSet.file}）`);
        const data = await s.json();

        questions = Array.isArray(data.questions)? data.questions : [];
        if(!questions.length) throw new Error('套卷文件中 questions 为空');

        document.getElementById('currentSet').textContent =
          `当前套卷：${activeSet.title}（共 ${activeSet.count ?? questions.length} 题）`;

        renderQuiz();
        setStatus(`✅ 已加载：${activeSet.title}（${questions.length} 题）`);
      }catch(e){
        console.error(e);
        setStatus('❌ '+e.message);
        alert('加载失败：'+e.message+'\n\n请确认路径是否与仓库一致，大小写是否一致。');
      }finally{
        btn.disabled=false; btn.classList.remove('is-loading'); btn.textContent='加载整套';
      }
    }
    document.getElementById('load').onclick = onLoadClick;
    window.onLoadClick = onLoadClick;  // 让内联 onclick 能调用到

    // ========== 渲染 ==========
    function renderQuiz(){
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = questions.map((it,idx)=>{
        const name=`q${idx}`;
        const choices = it.choices.map((t,i)=>`
          <label style="display:block;margin:6px 0;">
            <input type="radio" name="${name}" value="${i}"> ${String.fromCharCode(65+i)}. ${t}
          </label>
        `).join('');
        return `
          <div class="card" data-idx="${idx}">
            <div style="font-weight:600;margin-bottom:6px;">${idx+1}. ${it.q}</div>
            <div>${choices}</div>
            <div id="exp-${idx}" class="small" style="display:none;margin-top:8px;"></div>
          </div>`;
      }).join('');

      wrongList=[]; onlyWrong=false;
      document.getElementById('actions').style.display='flex';
      document.getElementById('result').style.display='none';
      const toggleWrongBtn = document.getElementById('toggleWrong');
      toggleWrongBtn.style.display='none';
      toggleWrongBtn.textContent = '只看错题';
      document.getElementById('exportWrong').style.display='none';
      document.getElementById('submit').disabled = false;

      // 开始计时
      examStartTs = Date.now();
      examEndTs = null;
      lastScore = 0;
      hasSubmitted = false;
      const limit = activeSet?.timeLimitMinutes ?? DEFAULT_TIME_LIMIT_MINUTES;
      startTimer(limit);
    }

    // ========== 判分 / 错题 / 导出 ==========
    async function submitQuiz(auto=false){
      if (hasSubmitted || !questions.length) return;
      hasSubmitted = true;
      stopTimer();
      deadlineTs = null;
      timerEl.textContent = '考试已结束';
      if (!examStartTs) examStartTs = Date.now();

      let score=0; wrongList=[];
      questions.forEach((it,idx)=>{
        const chosen=document.querySelector(`input[name="q${idx}"]:checked`);
        const userAns=chosen?Number(chosen.value):-1;
        const exp=document.getElementById(`exp-${idx}`);
        const ok=userAns===it.answer;
        if(ok) score++; else wrongList.push({...it,user:userAns});
        exp.style.display='block';
        exp.innerHTML = ok
          ? `✅ 正确：${String.fromCharCode(65+it.answer)}。${it.explanation||''}`
          : `❌ 你的答案：${userAns>=0?String.fromCharCode(65+userAns):'未作答'}；正确：${String.fromCharCode(65+it.answer)}。${it.explanation||''}`;
      });

      const r=document.getElementById('result');
      r.style.display='block';
      const end = new Date();
      examEndTs = end.getTime();
      lastScore = score;
      const durationSec = Math.max(0, Math.floor((examEndTs - examStartTs)/1000));
      const durationText = `${Math.floor(durationSec/60)}分${durationSec%60}秒`;
      const header = `<div><b>得分：${score}/${questions.length}</b> · 正确率 ${(score/questions.length*100).toFixed(0)}%</div>`;
      const meta = `<div class="small" style="margin-top:6px;">考试时间：${new Date(examStartTs).toLocaleString()} - ${end.toLocaleString()}（用时 ${durationText}）</div>`;
      r.innerHTML = header + meta + (auto ? '<div class="small" style="margin-top:6px;color:#facc15;">⏰ 时间到，系统已自动提交。</div>' : '');
      document.getElementById('toggleWrong').style.display='inline-block';
      document.getElementById('exportWrong').style.display=wrongList.length?'inline-block':'none';

      document.getElementById('submit').disabled = true;
      if (auto) setStatus('⏰ 时间已到，系统已自动提交。');

      // 保存到云端
      const payload = {
        module: document.getElementById('module').value,
        set_id: activeSet?.id || 'set',
        title: activeSet?.title || '',
        score: lastScore,
        total: questions.length,
        started_at: new Date(examStartTs).toISOString(),
        ended_at:   new Date(examEndTs).toISOString(),
        duration_sec: durationSec
      };
      const { error } = await supabase.from('results').insert({ user_id: user.id, ...payload });
      if (error) console.error('保存成绩失败：', error);
    }

document.getElementById('submit').addEventListener('click',()=>submitQuiz(false));

    document.getElementById('toggleWrong').addEventListener('click', () => {
      onlyWrong = !onlyWrong;
      questions.forEach((_, idx) => {
        const card = document.querySelector(`.card[data-idx="${idx}"]`);
        const isWrong = wrongList.some(w => w.q === questions[idx].q);
        card.style.display = (onlyWrong && !isWrong) ? 'none' : 'block';
      });
      document.getElementById('toggleWrong').textContent = onlyWrong ? '显示全部' : '只看错题';
    });

    document.getElementById('exportWrong').addEventListener('click',async ()=>{
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 48;
      let y = margin;
      const pageHeight = doc.internal.pageSize.getHeight();
      const lineHeight = 18;
      let fontReady = true;
      try {
        await ensurePdfFont(doc);
      } catch (err) {
        fontReady = false;
        console.error('PDF 字体加载失败：', err);
        alert('字体加载失败，导出的 PDF 可能会出现乱码。请检查网络后重试。');
      }

      if (!fontReady) {
        doc.setFont('helvetica', 'normal');
      }

      doc.setTextColor(20);


      const addText = (text, options={}) => {
        const { fontSize=12, gap=lineHeight } = options;
        doc.setFontSize(fontSize);
        if (fontReady && PDF_FONT_NAME) {
          doc.setFont(PDF_FONT_NAME, 'normal');
        } else {
          doc.setFont('helvetica', 'normal');
        }
        const lines = doc.splitTextToSize(text, doc.internal.pageSize.getWidth() - margin * 2);
        lines.forEach((line) => {
          if (y + gap > pageHeight - margin) {
            doc.addPage();
            y = margin;
            doc.setFontSize(fontSize);
            if (fontReady && PDF_FONT_NAME) {
              doc.setFont(PDF_FONT_NAME, 'normal');
            } else {
              doc.setFont('helvetica', 'normal');
            }
          }
          doc.text(line, margin, y);
          y += gap;
        });
      };

      const examTitle = activeSet?.title || 'ASVAB 模拟题';
      const examDate = examEndTs ? new Date(examEndTs) : new Date();
      addText(`错题报告 - ${examTitle}`, { fontSize: 18, gap: 26 });
      addText(`学员姓名：${studentName}`, { fontSize: 14 });
      addText(`考试日期：${examDate.toLocaleDateString()} ${examDate.toLocaleTimeString()}`, { fontSize: 14 });
      addText(`考试成绩：${lastScore}/${questions.length}`, { fontSize: 14, gap: 22 });

      if (!wrongList.length) {
        addText('恭喜，本次全部答对，没有错题记录。');
      } else {
        wrongList.forEach((w, idx) => {
          const correct = String.fromCharCode(65 + (w.answer ?? 0));
          const userAns = w.user != null && w.user >= 0 ? String.fromCharCode(65 + w.user) : '未作答';
          addText(`${idx + 1}. ${w.q}`, { fontSize: 13, gap: 20 });
          addText(`正确答案：${correct}    我的答案：${userAns}`, { fontSize: 12 });
          if (w.explanation) {
            addText(`解析：${w.explanation}`, { fontSize: 12 });
          }
          if (w.choices?.length) {
            w.choices.forEach((choice, cIdx) => {
              const label = String.fromCharCode(65 + cIdx);
              addText(`${label}. ${choice}`, { fontSize: 11, gap: 16 });
            });
          }
          y += 6;
        });
      }

      doc.save(`ASVAB_${activeSet?.id || 'set'}_错题_${examDate.toISOString().slice(0,10)}.pdf`);
    });

    // ========== 成绩记录（云端读取） ==========
    document.getElementById('viewHistory').addEventListener('click', async () => {
      const panel = document.getElementById('historyPanel');
      const willShow = panel.style.display === 'none';
      if (!willShow) { panel.style.display = 'none'; return; }

      const { data:list, error } = await supabase
        .from('results')
        .select('module,set_id,title,score,total,created_at,duration_sec')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(200);
      if (error) { panel.innerHTML = '<div class="small">加载失败。</div>'; panel.style.display='block'; return; }

      if (!list.length) {
        panel.innerHTML = '<div class="small">暂无记录。</div>'; panel.style.display='block'; return;
      }
      panel.innerHTML = '';

      const titleEl = document.createElement('div');
      titleEl.style.fontWeight = '600';
      titleEl.style.marginBottom = '8px';
      titleEl.textContent = '成绩记录（仅本人）';
      panel.appendChild(titleEl);

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.style.textAlign = 'left';
      headerRow.style.borderBottom = '1px solid #334155';
      ['科目','套卷','得分','用时','时间'].forEach(text => {
        const th = document.createElement('th');
        th.style.padding = '6px 4px';
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      list.forEach(r => {
        const row = document.createElement('tr');
        const cells = [
          r.module,
          r.title || r.set_id,
          r.score + '/' + r.total,
          (r.duration_sec || 0) + 's',
          new Date(r.created_at).toLocaleString()
        ];
        cells.forEach(value => {
          const td = document.createElement('td');
          td.style.padding = '6px 4px';
          td.textContent = value;
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      panel.appendChild(table);
      panel.style.display = 'block';
    });
  </script>
</body>
</html>