<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASVAB æ¨¡æ‹Ÿé¢˜ï¼ˆæ•´å¥—ï¼‰</title>
  <style>
    body{background:#0b1220;color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#0f172a80;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
    h1{font-size:40px;margin:28px 0}
    .small{opacity:.8;font-size:14px}
    a,select,button,input{font:inherit}
    .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:.65rem 1rem;border-radius:.8rem;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;border:0;padding:.7rem 1.2rem;border-radius:.8rem;box-shadow:0 6px 20px rgba(59,130,246,.25),0 2px 6px rgba(6,182,212,.35);transition:transform .08s ease,filter .2s ease;cursor:pointer}
    .btn-primary:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn-primary:active{transform:translateY(0);filter:brightness(.98)}
    .btn-primary[disabled]{opacity:.65;cursor:not-allowed;box-shadow:none}
    .btn-primary.is-loading{position:relative;color:transparent}
    .btn-primary.is-loading::after{content:"";position:absolute;inset:0;margin:auto;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.6);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand a{color:#e5e7eb;text-decoration:none}
  </style>
</head>
<body>
  <header class="wrap" style="display:flex;justify-content:space-between;align-items:center;">
    <div class="brand" style="font-weight:700">
      <a href="index.html">ASVAB å­¦ä¹ æŒ‡å—</a>
    </div>
    <div class="small" style="display:flex;gap:12px;align-items:center">
      <a href="index.html" class="btn" style="padding:6px 10px">ğŸ  è¿”å›é¦–é¡µ</a>
      <span id="whoami"></span>
    </div>
  </header>

  <main class="wrap">
    <h1>ASVAB æ¨¡æ‹Ÿé¢˜ï¼ˆæ•´å¥—ï¼‰</h1>

    <div class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <label>ç§‘ç›®ï¼š
        <select id="module">
          <option value="AR">AR ç®—æœ¯æ¨ç†</option>
          <option value="MK">MK æ•°å­¦çŸ¥è¯†</option>
          <option value="WK">WK / PC è¯æ±‡ä¸é˜…è¯»</option>
          <option value="GS">GS è‡ªç„¶ç§‘å­¦</option>
        </select>
      </label>

      <label>é™æ—¶ï¼š
        <input id="limitMin" type="number" value="20" min="1" style="width:70px"> åˆ†é’Ÿ
      </label>

      <button id="load" class="btn-primary" onclick="onLoadClick()">åŠ è½½æ•´å¥—</button>

      <span id="currentSet" class="small" style="margin-left:auto"></span>
      <span id="timer" class="small" style="min-width:92px;text-align:right"></span>
      <button id="logout" class="btn">é€€å‡ºç™»å½•</button>
    </div>

    <div id="status" class="wrap small" style="padding-top:0;color:#93c5fd"></div>

    <div id="quiz"></div>

    <div class="card" id="actions" style="display:none;gap:12px;align-items:center">
      <button id="submit" class="btn-primary">æäº¤ç­”æ¡ˆ</button>
      <button id="toggleWrong" class="btn-primary" style="display:none">åªçœ‹é”™é¢˜</button>
      <button id="exportWrong" class="btn-primary" style="display:none">å¯¼å‡ºé”™é¢˜ PDF</button>
      <button id="viewHistory" class="btn">æŸ¥çœ‹æˆç»©è®°å½•</button>
    </div>

    <div class="card" id="result" style="display:none"></div>
    <div class="card" id="historyPanel" style="display:none;max-width:100%;overflow:auto"></div>
  </main>

  <!-- é€»è¾‘ -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // TODO: æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ï¼ˆä¿æŒä¸åŸæ¥ä¸€è‡´å³å¯ï¼‰
    const supabase = createClient(
      "https://tsximmhtxysoeabxwlkv.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzeGltbWh0eHlzb2VhYnh3bGt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA2MTcsImV4cCI6MjA3NjM3NjYxN30.PQ0Fldv-vl4o_LH9niy2IbJwhcrCPbsaEM7sLEgXf8U"
    );

    // ========== ç™»å½•æ€ ==========
    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;
    if (!session) { location.href = "auth.html"; throw new Error("Not signed in"); }
    const user = session.user;

    // å­¦å‘˜å§“åä¼˜å…ˆé¡ºåºï¼šprofiles.full_name â†’ user_metadata.full_name/name â†’ æœ¬åœ°ç¼“å­˜ â†’ é‚®ç®±
    async function resolveStudentName() {
      const metaName = user.user_metadata?.full_name || user.user_metadata?.name || "";
      const localName = localStorage.getItem("asvab_student_name") || "";
      let profileName = "";

      const { data: profile } = await supabase
        .from("profiles")
        .select("full_name")
        .eq("id", user.id)
        .maybeSingle();
      profileName = profile?.full_name || "";

      let name = profileName || metaName || localName;
      if (!name) {
        name = prompt("è¯·è¾“å…¥æ‚¨çš„å§“åï¼ˆå°†æ˜¾ç¤ºåœ¨æˆç»©ä¸å¯¼å‡ºPDFä¸­ï¼‰ï¼š")?.trim() || "";
        if (name) {
          localStorage.setItem("asvab_student_name", name);
          // å°è¯•å†™å› profilesï¼ˆå¿½ç•¥å¤±è´¥ï¼‰
          await supabase.from("profiles").upsert({ id: user.id, full_name: name });
        }
      } else {
        // åŒæ­¥ä¸€ä»½åˆ°æœ¬åœ°ï¼Œä¾¿äºç¦»çº¿æ˜¾ç¤º
        localStorage.setItem("asvab_student_name", name);
      }
      return name || user.email;
    }

    const studentName = await resolveStudentName();
    document.getElementById("whoami").textContent = `å­¦å‘˜ï¼š${studentName}`;

    // é€€å‡ºç™»å½•
    document.getElementById("logout").onclick = async () => {
      await supabase.auth.signOut();
      location.href = "auth.html";
    };

    // ========== UI / çŠ¶æ€ ==========
    const setStatus = (t) => document.getElementById("status").textContent = t || "";
    let activeSet = null, setsOfModule = [], questions = [], wrongList = [], onlyWrong = false;
    let examStartTs = null, examEndTs = null, lastScore = 0, submitted = false;

    // è®¡æ—¶å™¨
    let timerId = null, deadlineTs = null;
    const timerEl = document.getElementById("timer");

    function startTimer(limitMinutes) {
      clearInterval(timerId);
      if (!limitMinutes || limitMinutes <= 0) { timerEl.textContent = ""; return; }
      deadlineTs = examStartTs + limitMinutes * 60 * 1000;
      tick(); // å…ˆæ¸²æŸ“ä¸€æ¬¡
      timerId = setInterval(tick, 500);
      function tick() {
        const left = Math.max(0, deadlineTs - Date.now());
        const mm = String(Math.floor(left / 60000)).padStart(2, "0");
        const ss = String(Math.floor((left % 60000) / 1000)).padStart(2, "0");
        timerEl.textContent = `âŒ› ${mm}:${ss}`;
        if (left <= 0) {
          clearInterval(timerId);
          if (!submitted) {
            alert("æ—¶é—´åˆ°ï¼Œå·²è‡ªåŠ¨æäº¤ã€‚");
            doSubmit(true); // è‡ªåŠ¨äº¤å·
          }
        }
      }
    }

    // ========== è½½å…¥æ•´å¥— ==========
    async function onLoadClick(){
      const btn=document.getElementById('load');
      const mod=document.getElementById('module').value;
      const limitMin = Number(document.getElementById('limitMin').value || 0);

      btn.disabled=true; btn.classList.add('is-loading'); btn.textContent='åŠ è½½ä¸­â€¦';
      setStatus('å¼€å§‹åŠ è½½æ¸…å•ï¼š/exams/manifest.json');

      try{
        const m = await fetch('exams/manifest.json?v=1',{cache:'no-store'});
        if(!m.ok) throw new Error('manifest.json åŠ è½½å¤±è´¥ï¼šHTTP '+m.status);
        const manifest = await m.json();

        if(!manifest[mod] || !manifest[mod].length){
          throw new Error(`manifest ä¸­æ²¡æœ‰ç§‘ç›® ${mod} çš„å¥—å·æ¡ç›®`);
        }
        setsOfModule = manifest[mod];
        activeSet = setsOfModule[0];

        setStatus(`æ‰¾åˆ°å¥—å·ï¼š${activeSet.title}ï¼Œå¼€å§‹åŠ è½½ ${activeSet.file}`);
        const s = await fetch(`${activeSet.file}?v=1`,{cache:'no-store'});
        if(!s.ok) throw new Error(`å¥—å·æ–‡ä»¶åŠ è½½å¤±è´¥ï¼šHTTP ${s.status}ï¼ˆ${activeSet.file}ï¼‰`);
        const data = await s.json();

        questions = Array.isArray(data.questions)? data.questions : [];
        if(!questions.length) throw new Error('å¥—å·æ–‡ä»¶ä¸­ questions ä¸ºç©º');

        document.getElementById('currentSet').textContent =
          `å½“å‰å¥—å·ï¼š${activeSet.title}ï¼ˆå…± ${activeSet.count ?? questions.length} é¢˜ï¼‰`;

        renderQuiz(limitMin);
        setStatus(`âœ… å·²åŠ è½½ï¼š${activeSet.title}ï¼ˆ${questions.length} é¢˜ï¼‰`);
      }catch(e){
        console.error(e);
        setStatus('âŒ '+e.message);
        alert('åŠ è½½å¤±è´¥ï¼š'+e.message+'\n\nè¯·ç¡®è®¤è·¯å¾„æ˜¯å¦ä¸ä»“åº“ä¸€è‡´ï¼Œå¤§å°å†™æ˜¯å¦ä¸€è‡´ã€‚');
      }finally{
        btn.disabled=false; btn.classList.remove('is-loading'); btn.textContent='åŠ è½½æ•´å¥—';
      }
    }
    document.getElementById('load').onclick = onLoadClick;
    window.onLoadClick = onLoadClick;

    // ========== æ¸²æŸ“ ==========
    function renderQuiz(limitMin){
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = questions.map((it,idx)=>{
        const name=`q${idx}`;
        const choices = it.choices.map((t,i)=>`
          <label style="display:block;margin:6px 0;">
            <input type="radio" name="${name}" value="${i}"> ${String.fromCharCode(65+i)}. ${t}
          </label>
        `).join('');
        return `
          <div class="card" data-idx="${idx}">
            <div style="font-weight:600;margin-bottom:6px;">${idx+1}. ${it.q}</div>
            <div>${choices}</div>
            <div id="exp-${idx}" class="small" style="display:none;margin-top:8px;"></div>
          </div>`;
      }).join('');

      wrongList=[]; onlyWrong=false; submitted=false;
      document.getElementById('actions').style.display='flex';
      document.getElementById('result').style.display='none';
      const toggleWrongBtn = document.getElementById('toggleWrong');
      toggleWrongBtn.style.display='none';
      toggleWrongBtn.textContent = 'åªçœ‹é”™é¢˜';
      document.getElementById('exportWrong').style.display='none';

      // å¼€å§‹è®¡æ—¶
      examStartTs = Date.now();
      examEndTs = null; lastScore = 0;
      startTimer(limitMin);
    }

    // ========== åˆ¤åˆ† / é”™é¢˜ / å¯¼å‡º PDF ==========
    async function doSubmit(auto=false){
      if (submitted) return;
      submitted = true;
      clearInterval(timerId);

      let score=0; wrongList=[];
      questions.forEach((it,idx)=>{
        const chosen=document.querySelector(`input[name="q${idx}"]:checked`);
        const userAns=chosen?Number(chosen.value):-1;
        const exp=document.getElementById(`exp-${idx}`);
        const ok=userAns===it.answer;
        if(ok) score++; else wrongList.push({...it,user:userAns});
        exp.style.display='block';
        exp.innerHTML = ok
          ? `âœ… æ­£ç¡®ï¼š${String.fromCharCode(65+it.answer)}ã€‚${it.explanation||''}`
          : `âŒ ä½ çš„ç­”æ¡ˆï¼š${userAns>=0?String.fromCharCode(65+userAns):'æœªä½œç­”'}ï¼›æ­£ç¡®ï¼š${String.fromCharCode(65+it.answer)}ã€‚${it.explanation||''}`;
      });

      const r=document.getElementById('result');
      r.style.display='block';
      r.innerHTML=`<b>å¾—åˆ†ï¼š${score}/${questions.length}</b> Â· æ­£ç¡®ç‡ ${(score/questions.length*100).toFixed(0)}%` + (auto?'ï¼ˆå·²è¶…æ—¶è‡ªåŠ¨æäº¤ï¼‰':'');
      document.getElementById('toggleWrong').style.display='inline-block';
      document.getElementById('exportWrong').style.display='inline-block';

      // ç»“æŸè®¡æ—¶ + ä¿å­˜åˆ°äº‘ç«¯
      examEndTs = Date.now();
      lastScore = score;
      const payload = {
        module: document.getElementById('module').value,
        set_id: activeSet?.id || 'set',
        title: activeSet?.title || '',
        score: lastScore,
        total: questions.length,
        started_at: new Date(examStartTs).toISOString(),
        ended_at:   new Date(examEndTs).toISOString(),
        duration_sec: Math.max(0, Math.floor((examEndTs - examStartTs)/1000))
      };
      const { error } = await supabase.from('results').insert({ user_id: user.id, ...payload });
      if (error) console.error('ä¿å­˜æˆç»©å¤±è´¥ï¼š', error);
    }

    document.getElementById('submit').addEventListener('click', ()=>doSubmit(false));

    document.getElementById('toggleWrong').addEventListener('click', () => {
      onlyWrong = !onlyWrong;
      questions.forEach((_, idx) => {
        const card = document.querySelector(`.card[data-idx="${idx}"]`);
        const isWrong = wrongList.some(w => w.q === questions[idx].q);
        card.style.display = (onlyWrong && !isWrong) ? 'none' : 'block';
      });
      document.getElementById('toggleWrong').textContent = onlyWrong ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™é¢˜';
    });

    // ç”Ÿæˆä¸€ä¸ªå¯æ‰“å°çš„ HTML å¹¶è°ƒç”¨æµè§ˆå™¨â€œæ‰“å°ä¸º PDFâ€
    function exportWrongAsPDF(){
      const score = lastScore;
      const total = questions.length;
      const acc = Math.round(score/total*100);
      const start = new Date(examStartTs).toLocaleString();
      const end   = new Date(examEndTs).toLocaleString();
      const dur   = Math.max(0, Math.floor((examEndTs - examStartTs)/1000));
      const items = wrongList.map((w,i)=>{
        const ua = w.user>=0 ? String.fromCharCode(65+w.user) : 'æœªä½œç­”';
        const ca = String.fromCharCode(65+w.answer);
        const choices = w.choices.map((c,j)=>`${String.fromCharCode(65+j)}. ${c}`).join('<br/>');
        return `
          <div style="margin:12px 0;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff">
            <div><b>${i+1}. ${w.q}</b></div>
            <div style="margin:6px 0">${choices}</div>
            <div>ä½ çš„ç­”æ¡ˆï¼š<b>${ua}</b>ï¼›æ­£ç¡®ç­”æ¡ˆï¼š<b>${ca}</b></div>
            ${w.explanation ? `<div style="margin-top:6px;color:#111827">è§£æï¼š${w.explanation}</div>` : ''}
          </div>
        `;
      }).join('');

      const blocks = `
        <div style="font-size:14px;color:#111827;margin-top:6px">
          å…± ${wrongList.length} é¢˜
        </div>
        ${items}
      `;

      const html = `<!doctype html>
<html><head><meta charset="utf-8">
<title>é”™é¢˜å¯¼å‡º - ${activeSet?.title||''}</title>
<style>
  @media print { @page { margin: 14mm; } }
  body{font:16px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#111827;margin:0;padding:18px}
  h1{font-size:22px;margin:0 0 10px}
  .grid{display:grid;grid-template-columns:140px 1fr;gap:6px 16px;margin:10px 0 18px}
</style>
</head>
<body>
  <h1>ASVAB é”™é¢˜å¯¼å‡ºï¼ˆPDFï¼‰</h1>
  <div class="grid">
    <div>å­¦å‘˜</div><div>${studentName}</div>
    <div>ç§‘ç›®/å¥—å·</div><div>${(document.getElementById('module').value)} / ${(activeSet?.title||activeSet?.id||'')}</div>
    <div>è€ƒè¯•æ—¶é—´</div><div>${start} â€” ${end}</div>
    <div>ç”¨æ—¶</div><div>${dur} ç§’</div>
    <div>å¾—åˆ† / é¢˜æ•°</div><div>${score} / ${total}ï¼ˆæ­£ç¡®ç‡ ${acc}%ï¼‰</div>
  </div>
  <h2 style="font-size:18px;margin:12px 0">é”™é¢˜æ˜ç»†</h2>
  ${items.length ? blocks : '<div>æ­å–œï¼Œæ²¡æœ‰é”™é¢˜ï¼</div>'}
  <script>setTimeout(()=>{window.print()},300)</script>
</body></html>`;
      const w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
    }

    document.getElementById('exportWrong').addEventListener('click', exportWrongAsPDF);

    // ========== æˆç»©è®°å½•ï¼ˆäº‘ç«¯è¯»å–ï¼‰ ==========
    document.getElementById('viewHistory').addEventListener('click', async () => {
      const panel = document.getElementById('historyPanel');
      const willShow = panel.style.display === 'none';
      if (!willShow) { panel.style.display = 'none'; return; }

      const { data:list, error } = await supabase
        .from('results')
        .select('module,set_id,title,score,total,created_at,duration_sec')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(200);
      if (error) { panel.innerHTML = '<div class="small">åŠ è½½å¤±è´¥ã€‚</div>'; panel.style.display='block'; return; }

      if (!list.length) {
        panel.innerHTML = '<div class="small">æš‚æ— è®°å½•ã€‚</div>'; panel.style.display='block'; return;
      }
      panel.innerHTML = '';

      const titleEl = document.createElement('div');
      titleEl.style.fontWeight = '600';
      titleEl.style.marginBottom = '8px';
      titleEl.textContent = 'æˆç»©è®°å½•ï¼ˆä»…æœ¬äººï¼‰';
      panel.appendChild(titleEl);

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.style.textAlign = 'left';
      headerRow.style.borderBottom = '1px solid #334155';
      ['ç§‘ç›®','å¥—å·','å¾—åˆ†','ç”¨æ—¶','æ—¶é—´'].forEach(text => {
        const th = document.createElement('th');
        th.style.padding = '6px 4px';
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      list.forEach(r => {
        const row = document.createElement('tr');
        const cells = [
          r.module,
          r.title || r.set_id,
          r.score + '/' + r.total,
          (r.duration_sec || 0) + 's',
          new Date(r.created_at).toLocaleString()
        ];
        cells.forEach(value => {
          const td = document.createElement('td');
          td.style.padding = '6px 4px';
          td.textContent = value;
          row.appendChild(td);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      panel.appendChild(table);
      panel.style.display = 'block';
    });
  </script>
</body>
</html>
