<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASVAB 模拟题（整套）</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .btn-primary{background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;border:0;padding:.7rem 1.2rem;border-radius:.8rem;box-shadow:0 6px 20px rgba(59,130,246,.25),0 2px 6px rgba(6,182,212,.35);transition:transform .08s ease,filter .2s ease}
    .btn-primary:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn-primary:active{transform:translateY(0);filter:brightness(.98)}
    .btn-primary[disabled]{opacity:.65;cursor:not-allowed;box-shadow:none}
    .btn-primary.is-loading{position:relative;color:transparent}
    .btn-primary.is-loading::after{content:"";position:absolute;inset:0;margin:auto;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.6);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#0f172a80;border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
    body{background:#0b1220;color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    h1{font-size:40px;margin:28px 0}
    .small{opacity:.8;font-size:14px}
    a,select,button{font:inherit}
  </style>
</head>
<body>
  <header class="wrap" style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-weight:700">ASVAB 学习指南</div>
    <nav><a href="/" style="color:#cbd5e1;text-decoration:none;margin-right:16px">首页</a><a href="about.html" style="color:#cbd5e1;text-decoration:none">关于</a></nav>
  </header>

  <main class="wrap">
    <h1>ASVAB 模拟题（整套）</h1>

    <div class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <label>科目：
        <select id="module">
          <option value="AR">AR 算术推理</option>
          <option value="MK">MK 数学知识</option>
          <option value="WK">WK / PC 词汇与阅读</option>
          <option value="GS">GS 自然科学</option>
        </select>
      </label>
      <!-- 兜底：onclick 必定生效 -->
      <button id="load" class="btn-primary" onclick="onLoadClick()">加载整套</button>
      <span id="currentSet" class="small" style="margin-left:auto"></span>
    </div>

    <!-- 可见状态栏 -->
    <div id="status" class="wrap small" style="padding-top:0;color:#93c5fd"></div>

    <div id="quiz"></div>

    <div class="card" id="actions" style="display:none;gap:12px;align-items:center">
      <button id="submit" class="btn-primary">提交答案</button>
      <button id="toggleWrong" class="btn-primary" style="display:none">只看错题</button>
      <button id="exportWrong" class="btn-primary" style="display:none">导出错题 JSON</button>
      <button id="retry" class="btn-primary" style="display:none" onclick="renderQuiz()">重做本套</button>
    </div>

    <div class="card" id="result" style="display:none"></div>
  </main>

  <script>
    // ====== 状态栏 ======
    function setStatus(msg){ document.getElementById('status').textContent = msg || '' }

    // ====== 全局状态 ======
    let activeSet=null, setsOfModule=[], questions=[], wrongList=[], onlyWrong=false;

    // ====== 载入流程（manifest -> 套卷 JSON -> 渲染） ======
    async function onLoadClick(){
      const btn=document.getElementById('load');
      const mod=document.getElementById('module').value;

      btn.disabled=true; btn.classList.add('is-loading'); btn.textContent='加载中…';
      setStatus('开始加载清单：/exams/manifest.json');

      try{
        // 1) 读 manifest
        const m = await fetch('exams/manifest.json?v=1',{cache:'no-store'});
        if(!m.ok) throw new Error('manifest.json 加载失败：HTTP '+m.status);
        const manifest = await m.json();

        if(!manifest[mod] || !manifest[mod].length){
          throw new Error(`manifest 中没有科目 ${mod} 的套卷条目`);
        }
        setsOfModule = manifest[mod];
        activeSet = setsOfModule[0]; // 默认第一套

        setStatus(`找到套卷：${activeSet.title}，开始加载 ${activeSet.file}`);

        // 2) 读套卷
        const s = await fetch(`${activeSet.file}?v=1`,{cache:'no-store'});
        if(!s.ok) throw new Error(`套卷文件加载失败：HTTP ${s.status}（${activeSet.file}）`);
        const data = await s.json();

        questions = Array.isArray(data.questions)? data.questions : [];
        if(!questions.length) throw new Error('套卷文件中 questions 为空');

        document.getElementById('currentSet').textContent =
          `当前套卷：${activeSet.title}（共 ${activeSet.count ?? questions.length} 题）`;

        renderQuiz();
        setStatus(`✅ 已加载：${activeSet.title}（${questions.length} 题）`);
      }catch(e){
        console.error(e);
        setStatus('❌ '+e.message);
        alert('加载失败：'+e.message+'\n\n请确认路径是否与仓库一致，大小写是否一致。');
      }finally{
        btn.disabled=false; btn.classList.remove('is-loading'); btn.textContent='加载整套';
      }
    }
    window.onLoadClick = onLoadClick;

    // ====== 渲染题目 ======
    function renderQuiz(){
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = questions.map((it,idx)=>{
        const name=`q${idx}`;
        const choices = it.choices.map((t,i)=>`
          <label style="display:block;margin:6px 0;">
            <input type="radio" name="${name}" value="${i}"> ${String.fromCharCode(65+i)}. ${t}
          </label>
        `).join('');
        return `
          <div class="card" data-idx="${idx}">
            <div style="font-weight:600;margin-bottom:6px;">${idx+1}. ${it.q}</div>
            <div>${choices}</div>
            <div id="exp-${idx}" class="small" style="display:none;margin-top:8px;"></div>
          </div>`;
      }).join('');

      wrongList=[]; onlyWrong=false;
      document.getElementById('actions').style.display='flex';
      document.getElementById('result').style.display='none';
      document.getElementById('toggleWrong').style.display='none';
      document.getElementById('exportWrong').style.display='none';
      document.getElementById('retry').style.display='inline-block';
    }

    // ====== 判分 / 错题 / 导出 ======
    document.getElementById('submit').addEventListener('click',()=>{
      let score=0; wrongList=[];
      questions.forEach((it,idx)=>{
        const chosen=document.querySelector(`input[name="q${idx}"]:checked`);
        const user=chosen?Number(chosen.value):-1;
        const exp=document.getElementById(`exp-${idx}`);
        const ok=user===it.answer;
        if(ok) score++; else wrongList.push({...it,user});
        exp.style.display='block';
        exp.innerHTML = ok
          ? `✅ 正确：${String.fromCharCode(65+it.answer)}。${it.explanation||''}`
          : `❌ 你的答案：${user>=0?String.fromCharCode(65+user):'未作答'}；正确：${String.fromCharCode(65+it.answer)}。${it.explanation||''}`;
      });
      const r=document.getElementById('result');
      r.style.display='block';
      r.innerHTML=`<b>得分：${score}/${questions.length}</b> · 正确率 ${(score/questions.length*100).toFixed(0)}%`;
      document.getElementById('toggleWrong').style.display='inline-block';
      document.getElementById('exportWrong').style.display=wrongList.length?'inline-block':'none';
    });

    document.getElementById('toggleWrong').addEventListener('click', () => {
      onlyWrong = !onlyWrong;
      questions.forEach((_, idx) => {
        const card = document.querySelector(`.card[data-idx="${idx}"]`);
        const isWrong = wrongList.some(w => w.q === questions[idx].q);
        card.style.display = (onlyWrong && !isWrong) ? 'none' : 'block';
      });
      document.getElementById('toggleWrong').textContent = onlyWrong ? '显示全部' : '只看错题';
    });


    document.getElementById('exportWrong').addEventListener('click',()=>{
      const data=wrongList.map(w=>({question:w.q,choices:w.choices,correctIndex:w.answer,userIndex:w.user??-1,explanation:w.explanation||''}));
      const blob=new Blob([JSON.stringify({exportedAt:new Date().toISOString(),exam:activeSet?.title||'',items:data},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`ASVAB_${(activeSet?.id||'set')}_错题_${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>